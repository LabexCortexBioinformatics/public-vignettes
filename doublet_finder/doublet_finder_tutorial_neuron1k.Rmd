---
title: "DoubletFinder tutorial on public data - Comparison with manual filtering"
author: "[LabEx CORTEX Bioinformatics Platform](https://labex-cortex.universite-lyon.fr/) - Lyon 1 University - vignette produced by Emeric Texeraud"
date: "`r Sys.Date()`"
output: html_notebook
---

### Load packages
```{r}
library(Seurat)
library(DoubletFinder)
library(scDblFinder)
```

```{r, warning=FALSE, include=TRUE}
# Load  the public dataset
seurat_matrix <- Read10X('/mnt/Data1/public_vignettes/cellranger_output/neuron_1k/outs/filtered_feature_bc_matrix')
seur <- CreateSeuratObject(counts = seurat_matrix, project = "neuron_1k", min.cells = 3, min.features = 100)
seur
```

## Identification of doublets using scDblFinder
```{r, fig.width=5, fig.asp=0.8, warning=FALSE, message=FALSE}
set.seed(1212524)
DefaultAssay(seur) = "RNA"
seur <- DietSeurat(seur, assays = 'RNA')
seur_sce <- as.SingleCellExperiment(seur)
# we run scDblFinder expecting 4% doublet rate as define for 10x
seur_sce <- scDblFinder(seur_sce)

seur_scDblFinder <- as.Seurat(seur_sce)
```
24 Doublets found (1.9%)

```{r}
Idents(seur_scDblFinder) <- "scDblFinder.class"
doublet = WhichCells(seur_scDblFinder, idents = "doublet")
VlnPlot(seur_scDblFinder, features = c("nFeature_RNA","nCount_RNA"), group.by = "scDblFinder.class")
```
All doublet seems to be in the upper half nCount_RNA of the cells, but they don't seem to have a significantly higher nCount than the other cells.

```{r}
# Load filtered dataset
seur_filtered <- readRDS("/mnt/Data1/public_vignettes/seurat_data/neuron_1k.rds")
```

```{r}
doublet_in_filtered <- Cells(seur_filtered)[Cells(seur_filtered) %in% doublet]
length(doublet_in_filtered)
singlet_in_filtered <- Cells(seur_filtered)[!Cells(seur_filtered) %in% doublet]
seur_filtered <- SetIdent(seur_filtered, cells = doublet_in_filtered, value = "doublet")
seur_filtered <- SetIdent(seur_filtered, cells = singlet_in_filtered, value = "singlet")
seur_filtered$doublet <- Idents(seur_filtered)
```
20 of the doublets found by scDblFinder are still in the manually filtered dataset.

```{r, fig.width=10, fig.asp=0.7, warning = FALSE, message=FALSE}
p1 <- DimPlot(seur_filtered, order = "doublet", pt.size=1) + NoAxes()
p2 <- DimPlot(seur_filtered, group.by = "clusters", label = TRUE) + NoLegend() + NoAxes()
p3 <- VlnPlot(seur_filtered, features = "nFeature_RNA", group.by = "doublet")
p4 <- VlnPlot(seur_filtered, features = "nCount_RNA", group.by = "doublet")
gridExtra::grid.arrange(p1, p2, p3, p4, ncol = 2)
```
Doublets don't seem to induce any bias in our data, as they are distributed in all our clusters without any clusters having a lots of them. Discarding or keeping them won't influence the subsequent analysis.
